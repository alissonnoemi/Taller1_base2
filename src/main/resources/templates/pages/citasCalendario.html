<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Calendario de Citas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet"/>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mx-auto my-10 p-4 bg-white rounded-xl shadow">
    <h1 class="text-3xl font-bold mb-6 text-center text-indigo-700">Calendario de Citas</h1>

    <div id='calendar'></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            editable: true,
            selectable: true,
            eventDurationEditable: true,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: function(fetchInfo, successCallback, failureCallback) {
                // Cambia la URL según el rol
                let url = '/citas/api/admin'; // Admin
                // let url = '/citas/api/cliente/[[${clienteId}]]'; // Cliente
                axios.get(url)
                    .then(res => {
                        const events = res.data.map(cita => ({
                            id: cita.idCita,
                            title: cita.cliente.nombreCompleto + " - " + cita.servicio.nombre,
                            start: cita.fechaHoraInicio,
                            end: cita.fechaHoraFin,
                            color: cita.estadoCita === 'CANCELADA' ? 'gray' : 'indigo'
                        }));
                        successCallback(events);
                    })
                    .catch(err => failureCallback(err));
            },
            eventDrop: function(info) {
                axios.put(`/citas/api/${info.event.id}/actualizar-fecha`, {
                    fechaHoraInicio: info.event.start.toISOString(),
                    fechaHoraFin: info.event.end.toISOString()
                }).catch(err => {
                    alert('Error al actualizar la cita: ' + err);
                    info.revert();
                });
            },
            eventClick: function(info) {
                if (confirm("¿Deseas cancelar esta cita?")) {
                    axios.put(`/citas/api/${info.event.id}/cancelar`)
                        .then(() => {
                            info.event.setProp('color', 'gray');
                        }).catch(err => alert('Error al cancelar: ' + err));
                }
            }
        });

        calendar.render();
    });
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
