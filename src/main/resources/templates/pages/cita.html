<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Agendar / Editar Cita</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-blue-50 to-white min-h-screen font-sans">
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mx-auto form-container mb-10 max-w-2xl mt-10 p-6 bg-white rounded-xl shadow">
    <h1 class="text-3xl font-bold mb-4 text-indigo-700 text-center" th:text="${cita.idCita != null ? 'Editar Cita' : 'Agendar Cita'}"></h1>

    <form th:action="${cita.idCita != null ? '/editarCita/' + cita.idCita : '/agendar'}" method="post" th:object="${cita}" class="space-y-4">
        <input type="hidden" th:field="*{idCita}" />

        <div>
            <label class="block font-semibold">Cliente:</label>
            <select th:field="*{cliente.id}" class="w-full border rounded p-2">
                <option value="">-- Selecciona un cliente --</option>
                <option th:each="cli : ${clientes}" th:value="${cli.id}" th:text="${cli.nombreCompleto}"></option>
            </select>
        </div>

        <div>
            <label class="block font-semibold">Negocio:</label>
            <select th:field="*{negocio.idNegocio}" class="w-full border rounded p-2" onchange="cargarProfesionalesYServicios()">
                <option value="">-- Selecciona un negocio --</option>
                <option th:each="neg : ${negocios}" th:value="${neg.idNegocio}" th:text="${neg.nombreNegocio}"></option>
            </select>
        </div>

        <div>
            <label class="block font-semibold">Servicio:</label>
            <select id="servicio" th:field="*{servicio.idServicio}" class="w-full border rounded p-2" onchange="actualizarDuracionServicio()">
                <option value="">-- Selecciona un servicio --</option>
            </select>
        </div>

        <div>
            <label class="block font-semibold">Duraci√≥n (minutos):</label>
            <input type="number" id="duracionServicioHoras" th:field="*{duracionServicioHoras}" readonly class="w-full border rounded p-2" />
        </div>

        <div>
            <label class="block font-semibold">Profesional:</label>
            <select id="profesional" th:field="*{profesional.idProfesional}" class="w-full border rounded p-2">
                <option value="">-- Selecciona un profesional --</option>
            </select>
        </div>

        <div>
            <label class="block font-semibold">Fecha y Hora Inicio:</label>
            <input type="datetime-local" th:field="*{fechaHoraInicio}" class="w-full border rounded p-2" />
        </div>

        <div>
            <label class="block font-semibold">Fecha y Hora Fin:</label>
            <input type="datetime-local" th:field="*{fechaHoraFin}" class="w-full border rounded p-2" />
        </div>

        <div>
            <label class="block font-semibold">Estado:</label>
            <select th:field="*{estadoCita}" class="w-full border rounded p-2">
                <option value="">-- Selecciona un estado --</option>
                <option th:each="estado : ${T(com.itsqmet.entity.Citas.EstadoCita).values()}" th:value="${estado}" th:text="${estado}"></option>
            </select>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded hover:bg-indigo-500">
                <span th:text="${cita.idCita != null ? 'Actualizar Cita' : 'Agendar Cita'}"></span>
            </button>
        </div>
    </form>
</div>

<script>
    function actualizarDuracionServicio() {
        const select = document.getElementById('servicio');
        const input = document.getElementById('duracionServicioHoras');
        const selected = select.options[select.selectedIndex];
        input.value = selected.getAttribute('data-duracion') || '';
    }

    function cargarProfesionalesYServicios() {
        const negocioId = document.querySelector('[th\\:field="*{negocio.idNegocio}"]').value;
        const profSelect = document.getElementById('profesional');
        const servSelect = document.getElementById('servicio');

        profSelect.innerHTML = '<option value="">-- Selecciona un profesional --</option>';
        servSelect.innerHTML = '<option value="">-- Selecciona un servicio --</option>';

        if(negocioId){
            fetch(`/api/profesionales/porNegocio/${negocioId}`)
                .then(res => res.json())
                .then(data => data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.idProfesional;
                    opt.textContent = p.nombreCompleto;
                    profSelect.appendChild(opt);
                }));
            fetch(`/api/servicios/porNegocio/${negocioId}`)
                .then(res => res.json())
                .then(data => data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.idServicio;
                    opt.textContent = s.nombre;
                    opt.setAttribute('data-duracion', s.duracionHoras);
                    servSelect.appendChild(opt);
                }));
        }
    }
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
